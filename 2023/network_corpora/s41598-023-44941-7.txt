introduction nuclear magnetic resonance nmr spectroscopy quantitative highly reproducible non-selective non-destructive method used diagnosis disease progression monitoring therapeutic intervention contrast standard high-field nmr spectroscopy acquisition operational cost low-field nmr lf-nmr substantially low lf-nmr employed measure small molecule large system lipid polymer rigid solid additionally innovative medical application detecting functionalized paramagnetic compound binding disease marker conducting metabolomics analysis body fluid like saliva urine cerebrospinal fluid via nmr spectrum however sensitivity one main challenge lf-nmr compounded signal overlap due reduced frequency dispersion chemical shift range resulting severe signal superposition nmr spectrum complex mixture complicating identification quantification halbach magnet based halbach array arrange permanent magnet generate strong highly homogeneous magnetic field enabled development new-generation portable nmr spectrometer magnetic field strength exceeding inhomogeneity ppm magnetic field homogeneity defined amplitude magnetic field strength divided mean magnetic field sweet spot magnet typically halbach magnet exhibit spatial field homogeneity value range 20–2000 ppm inadequate high-resolution nmr spectroscopy therefore constructed wide-bore halbach magnet consisting three concentric halbach array equipped extra layer quadrupole ferromagnetic cubic element guide magnetic field closed loop additionally design includes quadrupole triangular focusers fig concentrate resultant magnetic field sweet spot potential rotatable halbach layer integrated mechanical shim system explored complement electrical shim system achieving high-resolution nmr low field strength mechanical shimming system consists concentric rotatable halbach array fig providing variable magnetic field amplitude z-y plane z-direction fig thereby augmenting nmr magnetic field homogeneity moreover passive shimming achieved installing ferromagnetic cylinder magnet bore reducing primary nmr magnetic field allowing magnetic field adjustment lower nmr frequency optimal control theory employed design pulse suitable specific nmr spectroscopy task including selective excitation inversion decoupling coherence transfer hadamard encoding pulse sequence generated using krotov algorithm guide spin desired final state presence chemical shift inhomogeneity coupling innovatively designed optimal control pulse ocp selective excitation address low spectral dispersion enabling nmr spectroscopy low magnetic field lf-nmr spectrometer developed work improved customized specific application including real-time in-situ monitoring target molecule suppression interfering specie additionally provides contactless approach identifying quantifying target chemical compound multichemical mixture using pre-calculated ocp sequence low-filed nmr multilayer halbach magnet halbach cylinder generates stronger homogeneous magnetic field per unit mass compared dipolar permanent magnet furthermore generated magnetic field oriented perpendicular cylinder axis fig allowing incorporation solenoidal r.f coil enabling nmr experiment magnetic field direction rotated relative sample halbach magnet constructed arranging identical cubic magnet circular array resulting constructive magnetic field addition within ring interior leading dipolar field concept nmr halbach cylinder expanded implementing three nested halbach array fig using printing technology additionally rotatable shim cylinder integrated provide adjustable compensating magnetic field improved homogeneity z-axis doe align cylinder symmetry magnetic field component rotational shim cylinder contribute main magnetic field fig cubic magnet element within halbach cylinder positioned angle =2\pi i/n\ n−1 magnetization axis rotated relative z-axis fig identical magnet edge length corresponds layer number ranging placed center vector representing vector center halbach layer center magnet element expressed illustrated fig magnet positioned angle circle radius halbach cylinder characteristic defined parameter ring radius indirectly related magnet size number cubic magnet remanent magnetization coordinate magnet element denoting magnet vertex identification respectively described vector vector numbered clockwise center magnet defined figure construction principle halbach cylinder identical magnet size positioned center vector angle circle radius three-layered halbach magnet designed using autocad adhering halbach condition individual layer ensure constructive addition magnetic field eliminating directional magnetic component full size image +\frac array cos\left 2j-1 -\frac 4\pi sin\left 2j-1 -\frac 4\pi array array sin array range representing cube vertex varies n-1\ corresponds number magnet inner inner outer outer radius measured center cube positioned radius within specific layer determined inner 1-\sqrt n\right outer 1+\sqrt n\right represents number magnetic element stand radius central cylinder line layer radius layer radius layer radius layer parameter relates geometry volume halbach cylinder approximated n\right 2.26/ n-1.6 vertex coordinate polar coordinate defined r\xi n\right array 2j-1 -\frac 4\pi sin 2j-1 -\frac 4\pi array j=1 describing rotation magnet i=0 n-1\ represents magnet numbering magnetic moment calculated m=m\cdot correspond magnetization volume single cube magnet respectively cube magnet volume cylindrical halbach array expressed 2r\xi n\right leading m=m r\xi n\right case multilayer halbach magnet component magnetic field function summation contribution three layer x\right l=1 3/5 denotes layer order starting concentric point layer =16 =16 =12\ represents remanence individual magnet calculate magnetic field multilayer halbach magnet consists multiple stack x-direction halbach stack comprising ring treated dipole superposition term lead following expression x\right =\frac k=0 l=1 1+2k 5/2 figure illustrates numerical solution field along x-axis numerical solution derived finite stack oriented x-direction multilayer halbach magnet comprising three layer figure absolute magnetic field along x-axis black curve 3-concentric-rings halbach magnet magnet configuration result summation component magnetic field form magnetic field component direction become negligible sweet spot blue curve represents relative field inhomogeneity full size image relative field inhomogeneity along x-axis analytically calculated following comprehensive description soltner blümler consequently multilayer halbach magnet mlhm exhibit field inhomogeneity approximately ppm across sample volume absence combined shimming system specific parameter including inner outer completed halbach magnet provided table table key parameter 3-halbach layer rotatable shimming layer including inner outer value full size table fabrication characterization multilayer halbach magnet multilayer halbach magnet mlhm developed study three-layer cylindrical magnet nested rotatable inner layer halbach array mechanical shimming fig design rotatable mechanical shimming layer carried using cad finalized using high-resolution printer felixprinter fff printer sintered magnet element neodymium-iron-boron ndfeb grade n42 purchased ningbo permanent magnetic material ltd.-ngyc yinxian ningbo individual magnet nickel-coated cube side dimension 0.05 remanence =1350\ coercivity =923 maximum energy product max =318.3\ =42 mgoe furthermore completed halbach array includes quadrupole layer comprising four ferromagnetic cube side dimension made ferromagnetic steel coated nickel quadrupole layer designed manipulate magnetic field line concentrating bending strengthen magnetic field minimize magnetic stray field fig focusers simply approach design anti-bend magnet based quadrupole focusers form triangular cavity base height oriented shown fig filled iron powder enhance magnetic field sweet spot arrangement magnetic element layer follows cubic void alignment based illustrated fig figure multilayer halbach magnet designed using cad finalized printer three layer rotatable component magnetic focusers magnet element color-coded clarity fully assembled halbach magnet includes mechanical electrical shimming component along shimming kernel full size image facilitate mechanical shimming completed magnet enclosed thick aluminum frame allowing mounting micrometer screw magnetic field strength nominal sweet spot within magnet bore fine-tuned inserting ultrafine polished ferromagnetic cylinder made ferritic steel cylinder serf filler normalize stray magnetic field line reduce magnetic field strength enabling operation lower frequency mapping absolute field strength mlhm magnet equipping shim system mapped placing directional magnetometer gaussmeter inside magnet bore aligned parallel axis precise positioning magnetometer achieved using high-precision 3-axis stage micrometer thorlabs inc. mapping process encompassed entire usable volume indicated red circle fig furthermore mapping performed three specific slice located 1.5 1.5 within confined volume later occupied solenoid coil marked green circle mapping initiated nominal sweet spot magnet systematically moved cover data point within plane volume slice measurement carried inserting magnetometer attached 3-axis stage micrometer magnet bore absolute mapping conducted prior inserting shim system offer valuable insight overall field inhomogeneity magnet information crucial identifying shim-usable volume corresponds range electrical shimming capability distribution magnetic field strength calculated measured data point represented density plot shown fig a–f plotted point cover plane -1.5\ 1.5 figure absolute mapping conducted 3.4 bore mlhm magnet without operating shim system green circle represents complete volume mapping encompassed three volume slice within plane corresponding two end center slice subsequently illustrate absolute mapping usable cylindrical cavity green circle represent shim-usable volume shim system inserted depicts glass capillary 2.4 containing nmr solenoidal coil nmr sample located showing three slice within shim volume full size image shim process aimed rectify magnetic field inhomogeneity within available cylindrical cavity mlhm magnet =6\ =6\ denoted inner green circle fig employing combined mechanical electrical approach refer mechanical shim system electrical shim system section effective shim applied volume fraction occupied sample within solenoidal coil approximately length inner diameter however entire cylindrical cavity =6\ =6\ shimmable probehead positioning capability within plane range 1.2 proved entirely adequate identifying homogeneous volume encompass sample thereby achieving narrowest line width optimal signal shape mechanical shim system rotatable homemade magnetic layer configured halbach form fig installed initial layer mlhm magnet highlighted yellowish-green labeled fig change orientation magnetic field vector within plane figure rotatable halbach layer served integrated mechanical shim system adjusting plane limited rotation within plane ranging -12^\circ\ +12^\circ\ full size image rotatable shim layer secured custom-made spring-loaded micrometer enabling reversible precise rotational adjustment 1⁄120 cubic element dimension within shim ring mechanical shimming system contributes magnetic component mechanical enhances -component achieve greater homogeneity fine shimming necessary channel therefore incorporated electrical shim system meet requirement electrical shim system wide-bore magnet designed accommodate electrical shimming system shown fig 7-channel shim system includes shim kernel helmholtz configuration support standard gradient shim coil design electrical component shim kernel connected programmable homebuilt digital 7-channel current source capable providing per channel resolution 0.05 fit within narrow bore halbach magnet used work shimming channel higher order omitted instead replaced typically used flexible printed circuit board pcb fr-4 copper shim coil wound hollow tube integrated part shim kernel depicted fig design shim kernel created using cad finalized employing printer dremel digilab 3d45 printer original shim system addressed shim coil included shim coil however work focused shim based configuration choice made influential achieving uniform magnetic field sweet spot available space within extremely small cavity needed accommodate sample shim kernel wire passive heat dissipation iii higher-order harmonic shim would required lithographic pattern pcb could mounted within shim kernel therefore selected higher order could managed copper wire elliptical form connecting channel forming second order described literature channel established reference shim coil axis subsequently shim coil rotates 90° around z-axis designated shim coil z-axis fixed direction halbach magnet shim coil rotates 45° around y-axis correspondingly shim coil rotates 45° around z-axis labeled shim coil copper shimming coil coated three layer first layer zirconia excellent electrical insulator high thermal conductivity thermal conductivity 8.1 w/m applied provide electrical insulation mechanical protection coil second epoxy layer added top zirconia due high heat conduction low heat capacity finally silver-based resin applied enhance thermal conductivity facilitating greater passive heat dissipation three layer coated thickness ranging prevent thermal storage could lead temperature overshoot figure shimming kernel featuring 7-helmholtz axis coil designed using cad produced printing axis coil divided parallel path minimize ohmic heating full size image passive heat dissipation transfer using shim kernel adopted study including extension beyond magnet cavity power dissipation directly related total mass dissipater shim kernel volume approximately mass approximately effective surface area including internal component address joule heating generated shim system especially operating shimming current maximum level channel shim coil per channel split coil connected parallel reduce electrical resistance consequently running electrical current reduced quarter main channel current resulting fourfold reduction dissipated heat dis electrical current ohmic resistance sample spot reduction led decrease temperature 96.2 32.6 full operation current channel thick copper wire reduce joule heating important note magnetic field strength coil related ampere-turn coil turn result greater induced magnetic field strength thick copper wire may limit ability fulfill condition especially limited length approximately stage within shim kernel conclusion implementing two modification electrical shim system able operate typical shim current around 0.1 per channel without causing significant increase sample temperature approximately 0.1 ^\circ illustrated fig blue data point operating 7-axes shimming coil maximum current rare testing extreme condition involved operating shim channel half maximum full maximum current respectively validation purpose condition shim-kernel system exhibited stability temperature increase room temperature measured 0.3\ ^\circ 3.0\ ^\circ 5.0\ ^\circ current 0.1\ 1\mathrm 2\mathrm respectively figure temperature change sample site operation electrical shim system current 0.1 1.0 2.0 per shim channel illustrating effectiveness heat dissipation sample site full size image planar nmr probehead nmr probe fig constructed printed circuit board made glass-reinforced epoxy laminate rt4 double copper layer thickness layout resonance circuit r.f bnc copper track created nmr probehead board using lithography nmr resonator solenoidal coil copper wire diameter consisting turn wound around high-resolution nmr glass tube outer diameter inner diameter 2.4 solenoidal coil account major part inductance approximately 0.70 onboard copper track connector contribute 0.15 resonance circuit fig bonding wire connection point introduce impedance discontinuity leading increased transmission loss signal reflection particularly resonance frequency increase even low-field nmr therefore nmr probe designed solenoidal mini coil integrated planar design enhance sensitivity minimize inhomogeneity reduce impact bonding wire connection point impedance discontinuity signal transmission loss nonmagnetic trim multi-turn ceramic chip capacitor voltronics corp. salisbury usa used tune match resonance circuit 29.934 mhz nutation spectrum fig mounted solenoid mini-coil probe-head demonstrates strength homogeneity r.f field case signal intensity function pulse length reveals strong r.f field power sample temperature detected using pt100 sensor positioned near sample temperature calibration sweet spot achieved based chemical shift difference ethylglycol electrical circuit nmr probe-head including matching tuning capacitor shown fig probe-head successfully achieved hard pulse length 1.55 figure solenoidal-based nmr resonator probehead including on-chip thermal element bnc r.f connector electrical connection electrical circuit nmr probehead tuned matched 29.934 mhz showing tuning matching capacitor ohmic resistance circuit coil consists turn 3.4 inductance approximately 0.70 using copper wire diameter 0.2 inductance onboard copper strip line connector approximately 0.15 nutation curve obtained probehead full size image sensitivity homebuilt planar nmr probe nmr experiment magnetic field strength 0.703 29.934 mhz determined using signal-to-noise ratio snr typically defined ratio height resonance interest twice root-mean-square noise level study snr anomeric proton sucrose measured quantify sensitivity planar nmr probe following typical protocol literature sucrose sample volume approximately concentration 21.8 snr directly proportional volume fraction occupied sample within coil making effective sample volume around experiment time accumulation scan taking 1.9 per scan snr limit detection n\mathrm lod calculated using formula n\mathrm lod =79 nmols 1/2 29.934 mhz calculated formula n\mathrm lod =3n\sqrt exp snr mol refers portion sample within detection volume exp total experiment time accumulated scan compare measurement one conducted nmr frequency 600.13 mhz result normalized multiplying factor following scaling relationship 7/4 lod fall within range 15–30 mg/l water signal obtained using onboard nmr probe within 3.0 2.4 nmr glass tube length shown fig black spectrum represents data acquired without shimming system resulting linewidth non-pure lorentzian spectral line shape due influence magnetic field inhomogeneity contrast blue spectrum acquired mechanical shimming alone electrical shimming demonstrates noticeable improvement reduced linewidth approximately 8.0 mostly lorentzian shape red spectrum acquired mechanical electrical shimming exhibit reduction linewidth 5.5 purely lorentzian signal shape indicating significantly enhanced homogeneity magnetic field figure water signal acquired without shimming system black mechanical shimming blue combined mechanical electrical shimming red full size image low-field nmr spectrometer homebuilt lf-nmr spectrometer fig equipped mlhb magnet operating 29.934 mhz connected pulse blaster interpreter spincore technology inc. gainesville usa instrument control magnetic field strength mlhb magnet adjusted within range 0.5–0.77 based thickness ferromagnetic cylindrical filler magnet cavity explained multilayer halbach magnet section consequently spectrometer operate frequency ranging 21.25 32.78 mhz proton requiring appropriate tuning matching nmr probehead pulse blaster interpreter spincore technology inc. gainesville usa utilized instrument control figure homebuilt lf-nmr system equipped mlhb magnet labeled component nmr probe-head ground coupling gnd multilayer halbach magnet mlhb mechanical shim system 3d-stage micrometer thermally isolated r.f.-shielded box nmr console pulse programmer pulse generator power amplifier full size image magnet used exhibit homogeneity within cylindrical free volume measuring 2.4 diameter length coil length larger intended sample size prevent linewidth broadening nmr probe-head mounted high-precision 3-axis stage micrometer locate magnet sweet spot conducting nmr measurement additionally high-precision rotation stage adjustable increment thorlabs inc. employed rotate entire magnet relative probe-head enhancing alignment perpendicular magnet probehead alignment improvement contributed experimentally achieving narrower linewidth temperature control system magnet nmr probe housed homebuilt r.f shielded box made thick aluminum box thermally insulated using formfitting polyurethane foam jacket equipped heating system temperature regulation achieved standalone programmable commercial temperature controller passive vibration isolation measure implemented suppress mechanical vibration amplitude-modulated pulse generated using radio processor board spincore technology inc. gainesville usa figure present plot illustrating measured nmr signal amplitude variation response change power 90° pulse fixed pulse duration optimized separately 1.9 central resonance frequency analysis aimed determine parameter effective optimized nmr measurement revealing power range 1.9–2.5 central resonance frequency within yielded optimal result decrease amplitude even off-resonance frequency within range figure plot illustrating variation nmr signal amplitude function power power 90° hard pulse central resonance frequency full size image discussion application selective excitation pulse spin system editing achieved using krotov algorithm optimal control theory employ gradient-based approach monotonically enhance objective function iteration incorporates second-order derivative improve convergence particularly near optimum detail krotov algorithm found neat acetic acid selected due non-coupled system nature difference approximately 9.8 ppm two targeted nmr signal hydroxyl methyl proton signal serf test subject assessing krotov algorithm performance low-field nmr hamiltonian neat acetic acid described follows =2\uppi represent spin methyl group represents spin hydroxyl group acetic acid spin matrix denoted corresponding resonance frequency methyl group =-140.8\ hydroxyl group =140.2\ calculation performed state-to-state transfer initial terminal operator defined system follows spin group methyl group excitation initial operator ini initial operator ini terminal operator terminal operator spin group hydroxyl group initial operator ini initial operator ini terminal operator terminal operator fidelity calculation represent calculated pulse propagator spin system respectively determined fidelity real\ trace ini real\ trace ini pulse calculation performed using matlab version r2019a utilizing algorithm based code literature optimal control pulse duration typically iteration algorithm employed achieve convergence resulted calculation time minute executed intel core system ram experimental h-nmr spectrum acquired applying hard pulse selective excitation pulse using lf-nmr approximately 0.7 corresponding simulated experimental spectrum displayed fig respectively crosstalk signal cooh proton simulation indicated fig slight phase error methyl signal despite acetic acid dipolar coupling gaussian selective excitation used spectral editing nevertheless excellent example since two signal appeared experimentally 2.05 ppm methyl 11.67 ppm hydroxyl separated approximately 9.62 ppm nmr frequency 29.934 mhz fig nmr signal hydroxyl group acetic acid shift toward average chemical shift hydroxyl group neat acetic acid 11.8 ppm water signal chemical shift 4.75 ppm considering concentration proton side acetic acid example work clearly demonstrates excitation suppression efficiency wanted unwanted signal without interference low-field nmr typically pulse coupling non-coupling system calculated using amplitude phase modulation however non-coupling system like acetic acid exclusively calculated based amplitude modulation sufficient advantage avoiding first-order phase error making convergence much faster figure simulated experimental h-nmr spectrum 29.934 mhz neat acetic acid using optimal control pulse excite proton hydroxyl proton methyl proton pulse calculated using amplitude phase modulation based krotov algorithm full size image simulation experimental spectrum demonstrate complete suppression unwanted signal furthermore relative amplitude desired signal respect oc-hp remain consistent showcasing robust implementation optimal control algorithm low larmor frequency performance efficiency krotov optimal control pulse compared gaussian pulse assessed hydroxyl methyl proton group neat acetic acid applied gaussian pulse cutoff offset targeted signal maximum power level 4.25 pulse length 20.4 excitation suppression factor respectively krotov gaussian case calculated based absolute integration hydroxyl methyl proton signal relative absolute integration obtained applying hard pulse shown table gaussian pulse suppressed unwanted signal factor 0.03 similar performance krotov selective pulse 0.04 however value desired signal using gaussian pulse averaging 0.63 exhibit significant difference compared achieved pulse averaging 0.81 furthermore gaussian pulse applied continuous range frequency krotov selective pulse target signal notably since pulse operate much lower power 0.08–0.1 compared hard pulse operating power range 1.9–2.2 table factor signal group excited gaussian krotov pulse full size table study demonstrated feasibility applying optimal control pulse subspectral editing field strength low 0.7 allows use selective excitation pulse targeting individual component multicomponent mixture within realm lf-nmr capability significant interest selective excitation application related pharmaceutical product characterization point-of-care diagnostics application conclusion applicability lf-nmr system across various field requires innovative development particularly enhancing magnetic homogeneity sensitivity resolution integration multilayer halbach magnet combined mechanical electrical shimming system onboard nmr probehead selective excitation pulse demonstrated study potential accelerate advancement portable low-field nmr multilayer halbach magnet designed finished attain strong uniform magnetic field main direction rotatable halbach array designed offer magnetic field shimming z-y plane successfully improved homogeneity compared standard dipolar permanent magnet probehead manufactured fit single board minimal electrical jointing point electrical component minimizing impedance discontinuity transmission loss signal reflection optimal control pulse based krotov algorithm successfully implemented molecular spectral excitation sub-spectral excitation even amplitude modulation demonstrated spectral editing neat acetic acid supporting lf-nmr spectrometer application even limited pulse programmer capability obtained result show great promise applied targeted analysis overlapped nmr spectral line low magnetic field strength development open opportunity using benchtop nmr spectrometer efficient analytical tool creating significant added value process analytics